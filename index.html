<!doctype html>
<html>
  <link rel="stylesheet" href="index.css" />
  <link
    href="https://fonts.googleapis.com/css?family=Manrope"
    rel="stylesheet"
  />
  <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script>
    window.onload = function () {
      document
        .querySelector(".header-close-button")
        .addEventListener("click", function () {
          // here you can change also a-scene or a-entity properties, like
          // changing your 3D model source, size, position and so on
          // or you can just open links, trigger actions...
        });

      const marker = document.querySelector("a-marker");
      const notificationMessage = document.querySelector(
        ".notification-wrapper"
      );

      marker.addEventListener("markerFound", (e) => {
        notificationMessage.style.display = "none";
      });

      marker.addEventListener("markerLost", (e) => {
        notificationMessage.style.display = "flex";
      });

      const params = new URLSearchParams(new URL(window.location.href).search);
      let vin = null;
      if (params.has("vin")) vin = params.get("vin");

      if (vin) {
        fetch(
          `https://tds-test2.itorum.ru/api/on_board_information_system/augmented_reality_coordinates?vin=${vin}`
        )
          .then((res) => res.json())
          .then((res) => {
            for (const key in res) {
              if (res.hasOwnProperty(key)) {
                const item = res[key];

                const title = key;

                const coords = `${item.coordinates.x} ${item.coordinates.y} ${item.coordinates.z}`;

                const techmap = item["technical map"];

                const description = item.description;

                console.info(coords);
                const entity = document.createElement("a-entity");
                entity.setAttribute("rotation", "-90 180 0");
                entity.setAttribute("position", "0 0 0");
                // entity.setAttribute("position", coords);
                entity.setAttribute("material", "src: #info");
                entity.setAttribute(
                  "geometry",
                  "primitive: circle; radius: 0.2"
                );
                entity.setAttribute("infocomponent", "");
                entity.addEventListener("click", () => openModal(title, item));

                const follower = document.querySelector("#follower");
                follower.appendChild(entity);
              }
            }
          })
          .catch((e) => alert(e));
      } else alert("Ошибка клиента: vin не найден");
    };

    function closeModal() {
      const modal = (document.querySelector(".wrapper").style.display = "none");

      document
        .querySelectorAll(".main-content-items")
        .forEach((elem) => elem.parentNode.removeChild(elem));

      [...document.querySelector(".tabs").childNodes].forEach((e) =>
        e.remove()
      );
    }

    // TODO:
    // 1. REDURANT CODE
    // 2. CLOSEMODAL() SHOULD REMOVE MODAL AND OPENMODAL() SHOULD CREATE MODAL
    function openModal(title, obj) {
      const modal = (document.querySelector(".wrapper").style.display = "flex");
      console.error(obj);
      const headerText = document.querySelector(".header-text");
      headerText.textContent = title;

      const { description, "technical map": technicalMap } = obj;

      const mainContentItems = document.createElement("div");
      mainContentItems.className = "main-content-items";

      const tabs = document.querySelector(".tabs");
      let counter = -1;
      // Create main content item div
      if (description.length) {
        counter++;
        const tab = document.createElement("div");
        tab.addEventListener("click", () => handleTab(0));
        tab.className = "tab tab-active";
        tab.textContent = "Руководство по эксплуатации";
        tabs.append(tab);

        description.forEach(({ title }) => {
          const mainContentItem = document.createElement("div");
          mainContentItem.className = "main-content-item";

          // Create the main-content-text div
          const mainContentText = document.createElement("div");
          mainContentText.className = "main-content-text";
          mainContentText.textContent = title;
          mainContentText.onclick = () => {
            window.open("https://example.com");
          };

          // Create the main-content-button img
          const mainContentButton = document.createElement("img");
          mainContentButton.className = "main-content-button";
          mainContentButton.src = "go.svg";
          mainContentButton.alt = "open md";

          // Append the text and image to the main-content-item div
          mainContentItem.appendChild(mainContentText);
          mainContentItem.appendChild(mainContentButton);

          mainContentItems.append(mainContentItem);

          // Append the main-content-item to the body or any other container
          const container = document.querySelector(".main-content-container");
          container.appendChild(mainContentItems);
        });
      }
      //----------------------------------content
      console.log(technicalMap);

      const mainHiddenContentItems = document.createElement("div");
      mainHiddenContentItems.className =
        counter === -1
          ? "main-content-items"
          : "main-content-items hidden-item";

      if (technicalMap.length) {
        counter++;
        const tab = document.createElement("div");
        tab.addEventListener("click", () => handleTab(1));
        tab.className = counter === 0 ? "tab tab-active" : "tab tab-inactive";
        tab.textContent = "Технические карты";
        tabs.append(tab);
        technicalMap.map(({ title }) => {
          const mainContentItem = document.createElement("div");
          mainContentItem.className = "main-content-item";

          // Create the main-content-text div
          const mainContentText = document.createElement("div");
          mainContentText.className = "main-content-text";
          mainContentText.textContent = title;
          mainContentText.onclick = () => {
            window.open("https://example.com", "_blank");
          };

          // Create the main-content-button img
          const mainContentButton = document.createElement("img");
          mainContentButton.className = "main-content-button";
          mainContentButton.src = "go.svg";
          mainContentButton.alt = "open md";

          // Append the text and image to the main-content-item div
          mainContentItem.appendChild(mainContentText);
          mainContentItem.appendChild(mainContentButton);

          mainHiddenContentItems.append(mainContentItem);
          const container = document.querySelector(".main-content-container");
          container.appendChild(mainHiddenContentItems);
        });
      }
    }

    function handleTab(tabIndex) {
      const tabs = document.querySelectorAll(".tab");
      const contentItems = document.querySelectorAll(".main-content-items");

      tabs.forEach((tab, index) => {
        tab.classList.remove("tab-active");
        tab.classList.add("tab-inactive");
        contentItems[index].classList.add("hidden-item");
      });

      tabs[tabIndex].classList.remove("tab-inactive");
      tabs[tabIndex].classList.add("tab-active");
      contentItems[tabIndex].classList.remove("hidden-item");
    }

    function closeOrientationalModal() {
      const modal = document.querySelector(".wrapper-orientation-alert");
      modal.style.display = "none";

      const bodyElements = document.querySelectorAll(
        "body > *:not(.wrapper-orientation-alert)"
      );
      bodyElements.forEach((element) => {
        element.style.filter = "none";
      });
    }
  </script>
  <script>
    AFRAME.registerComponent("markerhandler", {
      init: function () {
        this.p = new THREE.Vector3();
        this.q = new THREE.Quaternion();
        this.s = new THREE.Vector3();

        let marker = this.el;
        let follower = document.querySelector("#follower");

        marker.addEventListener("markerFound", function () {
          markerVisible = true;
          follower.object3D.visible = true;
          console.log("found");
        });

        marker.addEventListener("markerLost", function () {
          markerVisible = false;
          follower.object3D.visible = false;
          console.log("lost");
        });
      },

      tick: function (time, deltaTime) {
        let marker = this.el;
        let follower = document.querySelector("#follower");

        marker.object3D.getWorldPosition(this.p);
        marker.object3D.getWorldQuaternion(this.q);
        marker.object3D.getWorldScale(this.s);

        follower.object3D.position.lerp(this.p, 1);
        follower.object3D.quaternion.slerp(this.q, 0.025);
        follower.object3D.scale.lerp(this.s, 0.025);
      },
    });

    AFRAME.registerComponent("infocomponent", {
      schema: {
        link: { type: "string", default: "" },
        name: { type: "string", default: "herohoehero" },
      },

      init: function () {
        console.log("init function:", this.el);
      },
      tick: function (time, timeDelta) {
        let plane = this.el;
        let camera = document.querySelector("[camera]");
        var position = camera.object3D.rotation;
        plane.object3D.lookAt(
          new THREE.Vector3(position.x, position.y, position.z)
        );
      },
    });
  </script>

  <body style="margin: 0px; overflow: hidden">
    <div class="wrapper-orientation-alert">
      <div class="modal-alert">
        <div class="phone-img">
          <img src="phone.svg" />
        </div>
        <div class="modal-alert-container">
          <div class="modal-alert-text">
            Поверните телефон горизонтально и убедитесь, что метка с надписью AR
            находится в поле зрения камеры
          </div>
        </div>
      </div>
    </div>
    <div class="wrapper">
      <div class="modal">
        <div class="modal-content">
          <div class="header">
            <div class="header-text">Информация</div>
            <img
              class="header-close-button"
              src="union.svg"
              alt="close button"
              onclick="closeModal()"
            />
          </div>
          <div class="main">
            <div class="tabs"></div>
            <div class="main-content">
              <div class="main-content-container"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="notification-wrapper">
      <div class="notification-message">
        Убедитесь, что QR-код находится в поле зрения камеры
      </div>
    </div>
    <a-scene
      embedded
      arjs="trackingMethod: best; sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;"
      cursor="fuse: false; rayOrigin: mouse;"
      vr-mode-ui="enabled: false"
    >
      <a-assets>
        <img id="info" src="info.png" alt="info" />
      </a-assets>

      <a-marker
        preset="hiro"
        raycaster="objects: .clickable"
        emitevents="true"
        cursor="fuse: false; rayOrigin: mouse;"
        id="markerA"
        markerhandler
        size="1"
        smooth="true"
        smoothCount="5"
        smoothTolerance="0.05"
        smoothThreshold="5"
      >
        >
      </a-marker>

      <a-entity id="follower"> </a-entity>
      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
